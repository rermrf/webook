### 服务注册与发现模型

#### IP 直连
最原始的形态，**就是直接使用 IP + 端口来通信。**

这个过程甚至不能称为服务注册与发现，因为没啥注册，也没啥发现。

缺点很明显：IP 是会变的 + 不好维护。

虽然它很原始，但是偶尔也会使用：
- **在开发环境要联调的时候**。例如说你和同事合作完成一个任务，而后你需要调用你同事的接口，这个时候，你直接用同事电脑的 IP 地址调用，同事就可以本地 DEBUG 了。
- **当你 DEBUG 的时候**。某些时候一些 BUG 只会在特定的某些实例上出现，这个时候你可以直接把请求发到这个实例上。


#### 使用域名 + DNS
既然直接使用 IP 不好用，那么另外一个可行的思路就是**使用域名 + DNS**

考虑到解析域名的开销，所以**一般会在客户端这边缓存 解析域名的结果**。

优点：
- 简单好用，不需要额外的组件。

缺点：
- 如果客户端不缓存 DNS 结果，那么每次调用都会多一次调用。
- 如果客户端缓存 DNS 结果，那么就可能无法及时更新本地可用节点列表。


#### 注册中心机制
既然域名解析的问题是不能及时得到通知，**那么能不能让域名服务器主动通知一下节点变化？**

这就是注册中心的原理，基本的思路就是：
- 服务器在启动的时候主动在注册中心注册一下。
- 客户端在第一次发起调用之前先查询注册中心，而后缓存住可用节点。
- 注册中心在服务端节点发生变动的时候，主动通知一下客户端。

这种形态没有显著的缺点。硬要说缺点，**就是注册中心在大规模集群下绒癌称为瓶颈。**


#### 服务自省
这是阿里 Dubbo 提出来的概念。

在原本的注册中心里面，随着集群规模增长和微服务复杂度上升，导致注册中心的数据越来越多，更新越来越频繁，就会导致注册中心本身成为瓶颈。

于是有了服务自省。它可以看做两个简单的过程：
- 保留注册中心，但是**注册中心里面只有最小化的数据。**
- 剩余的**跟服务有关的元数据，通过一个元数据服务来暴露。**

#### 借助网管的服务注册与发现
实际上，这个并不能算是服务注册与发现，只是说在实践中可能遇到，所以在这里描述一下这个模型

事实上当你的请求经过一个微服务网关的时候，**你首先得知道网关在哪里**。这个过程一般是通过域名来达成的，例如 getway.mycompany.com，或者一个特定的配置项里面得知所有的网关节点的地址。

而网关要把请求转发到真实服务端上，**也就是需要知道服务端的地址，因此这也是一个服务注册与发现的过程**，同样可以借助注册中心，或者 DNS。



### 注册中心机制

#### 服务启动过程
简单来说，服务端在启动的时候，**就需要在注册中心注册自身的信息。**

那么问题来了：服务端怎么知道注册中心在哪呢？

答案是：**一般是通过域名 + 端口或者直接指定 IP + 端口来连上注册中心。**

而且，正常来说如果在启动阶段的服务端A无法连上注册中心，那么服务端A会直接失败（也就是退出程序）。

#### 服务注册什么数据？
大致上可以分成两类：
- 定位信息。通俗来说，**就是 IP + 端口**。
- 其他信息。**这部分信息一般和微服务框架的具体功能有关系**，比如在支持分组功能的微服务框架里面，服务端节点就需要在注册信息里面带上自己的分组信息。

其中，最为关键的就是定位信息，因为客户端要利用这个信息来连上服务端A。


#### 服务端和注册中心保持心跳
在注册成功之后，注册中心会和服务端保持心跳。

根据注册中心选型，微服务框架设计，心跳有两种模式：
- **服务端主动**。也就是服务端每隔一段时间就朝着注册中心发一个心跳，注册中心可以答应也可以不答应（正常来说，服务端只要没收到网络错误，就可以认为和注册中心的联系是正常的）。
- **注册中心主动**。也就是注册中心会主动朝着所有注册的服务端节点发送心跳。

如果心跳失败，注册中心会判定服务端节点已经崩溃，那么就会通知客户端不要使用这个节点。


#### 心跳机制
本质上来说，注册中心和服务端的整个机制，可以看做是租约，心跳就是续租。

那么在租约里面讨论的心跳有关的问题，在注册机制这里一样要讨论。
- 心跳间隔多长？
- 如何判定节点连不上？是一次心跳就连不上，还是多次心跳连不上？

正常来说，这些都是跟业务有关的。核心就是：
- **间隔越短，心跳越频繁，压力越大。**
- **次数越少，越快发现服务端节点崩溃，但是难以应对偶发性心跳失败。**
- **次数越多，越慢发现服务端节点崩溃，但是可以避免一些偶发性心跳失败的问题。**


#### 心跳机制的高级做法
还有一些更加高级的机制，但是比较少采用，性价比不高。

- **双向心跳**。也就是服务端会主动发心跳，注册中心也会主动发心跳。
- **单向心跳失败之后，另外一边主动发起心跳**。例如说在正常情况下，都是服务端主动发心跳给注册中心，但是注册中心在一段时间没有收到服务端的心跳之后，会主动发起心跳。


#### 服务下线
很显然，如果服务端要关闭了，就需要通知注册中心，而后注册中心需要通知客户端。
**客户端会把该节点从可用节点列表里面挪走。**


#### 服务优雅下线

但是下线还有一些细节需要思考：服务端A能不能在告诉注册中心自己下线了，立刻就退出？

答案是不能。**因为这个时候服务端 A 上可能还有一些请求正在处理，而网上也还有客户端正在发请求。**

因此实际上，服务端 A 下线的过程更加复杂一点。

##### 服务优雅下线的具体步骤
- **首先通知注册中心**，服务端节点要下线了。
- **而后，服务端节点不再接受新请求**，包括在网络中读了一半的请求，也会在读完之后，直接拒绝。不会交给后端业务代码处理。
- **服务端需要等待正在处理的请求结束**。如果该服务端节点上还有类似于定时任务之类的东西，也要等待运行运行结束。
- **等服务端已经接收的请求处理完毕，服务端就会结束运行。**
- 进一步考虑部分请求运行太长时间，或者定时任务长时间不能结束，所以服务端节点的整个退出过程也会有超时控制，**超过超时时间，就会直接退出。**


#### 客户端
根据微服务框架的设计，客户端发起服务发现有两个时机。
- **客户端启动的时候**。这种设计一般是在客户端从配置文件，或者注册接口，拿到了所有需要使用的微服务。于是可以在初始化的过程中直接执行服务发现，如果服务发现失败则客户端不会启动。
- 客户端启动的时候，并没有去做服务发现。**而是在第一次调用某个服务的时候，执行服务发现**。

同样的，注册中心和客户端之间也要保持心跳，这样可以保证在服务端数据变更的时候，能够连上客户端，并且通知客户端。


### 服务注册与发现的高可用

#### 高可用的关键点
- 服务端崩了怎么办？
- 注册中心崩了怎么办？
- 客户端崩了怎么办？这个是不需要处理的，因为客户端都崩了就没办法发起调用了。

- 注册中心和服务端之间无法通信怎么办？
- 注册中心和客户端之间无法通信怎么办？这种情况，客户端采取“注册中心崩溃”一致行为来容错。
- 客户端和服务端之间无法通信怎么办？基本上也就是 failover 策略。


##### 服务端崩溃
在注册模型里面，正常来说注册中心能够发现服务端崩溃。

但是这需要时间。也就是说，服务端崩溃到注册中心发现、再到注册中心通知客户端，可能存在秒级的延迟。

这个时候，就要求客户端能够正常处理这个情况。

简单来说，**就是客户端发现服务端连不上之后，就要更换一个节点来重试**，这就是failover 策略。


##### 注册中心崩溃怎么办？ --注册中心高可用

那么首先第一个要确保的就是注册中心不能轻易崩溃。
- **启用注册中心的高可用方案**，例如说部署一个集群，多活方案。
- **双注册中心方案**：也就是注册的时候同时注册两个注册中心，在一个注册中心崩溃之后可以使用另外一个注册中心。
- **按照业务拆分多个注册中心**：也就是说一个公司内部不要只使用一个注册中心，最好是不同的业务使用不同的注册中心，核心业务和非核心业务使用不同的注册中心。

##### 注册中心崩溃怎么办？ --客户端怎么办
注册中心崩溃之后，后果之一就是客户端无法获得服务端变动的信息：例如上线或者下线等。

客户端要想容忍这个错误，可以考虑：
- **使用本地缓存的可用节点信息**，缺陷就是可能不准，有可能有些节点已经下线了，有些节点新加进来。
- 客户端使用本地缓存的节点信息之后，如果发起调用的时候发现无法连通，那么**就要把这个节点移出可用列表。**

但是，**如果一个新服务，因为客户端本身没有缓存任何的可用节点信息，那么就没有办法发起调用**，返回特定的错误，让调用者自己去决定怎么处理。

##### 注册中心崩溃怎么办？ --服务端怎么办
注册中心崩溃之后，服务端已经没有办法更新注册信息了。

- **如果是一个新节点，那么注册失败的时候，他应该直接退出服务。**
- 如果是一个老的节点，此时老客户端可能还在使用本地缓存的注册数据，所以**老节点应该继续提供服务**。

##### 注册中心和服务端之间无法通信

注册中心和服务端之间无法通信的情况下，注册中心会判定服务端已经崩溃，但是实际上服务端还活着。
这个时候，**在客户端收到注册中心的错误判定之前，依旧能够调用服务端，并且收到响应。**

客户端不需要做什么，服务端也不需要做什么，注册中心还是不需要做什么。

但是如果服务端发现自己一段时间无法和注册中心保持心跳之后，要告警，并且考虑要不要直接退出。

